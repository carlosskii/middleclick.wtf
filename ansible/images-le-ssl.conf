<VirtualHost *:80>
    ServerName middleclick.wtf
    ServerAlias www.middleclick.wtf

    DocumentRoot /var/www/middleclick.wtf

    ErrorLog ${APACHE_LOG_DIR}/middleclick.wtf-error.log
    CustomLog ${APACHE_LOG_DIR}/middleclick.wtf-access.log combined

    RewriteEngine On

    RewriteCond %{REQUEST_METHOD} ^POST$
    RewriteCond %{REQUEST_URI} ^/upload$
    RewriteRule ^.*$ http://localhost:8080/upload [P,L]

    RewriteCond %{HTTP_USER_AGENT} "(Discordbot|Macintosh)" [NC]
    RewriteCond %{REQUEST_URI} !^/images/
    RewriteRule ^/([^/]+)$ https://middleclick.wtf/images/$1 [R=302,L]

    RewriteCond %{HTTP_USER_AGENT} !"(Discordbot|Macintosh)" [NC]
    RewriteCond %{QUERY_STRING} ^redirect=([^&]+)$
    RewriteRule ^.*$ %1? [R=302,L]

    <Directory /var/www/middleclick.wtf>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted
    </Directory>

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/middleclick.wtf/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/middleclick.wtf/privkey.pem
</VirtualHost>